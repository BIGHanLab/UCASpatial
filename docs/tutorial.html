<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tutorial - UCASpatial</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <nav class="navbar">
        <!-- Navigation -->
    </nav>

    <section class="content-section">
        <div class="container">
            <h1>Step-by-Step Tutorial</h1>

            <div class="tutorial-nav">
                <ul class="tutorial-menu">
                    <li><a href="#data-preparation">Data Preparation</a></li>
                    <li><a href="#basic-usage">Basic Usage</a></li>
                    <li><a href="#visium-hd">10X Visium HD</a></li>
                    <li><a href="#visualization">Visualization</a></li>
                    <li><a href="#interpretation">Result Interpretation</a></li>
                </ul>
            </div>

            <div class="tutorial-content">
                <section id="data-preparation">
                    <h2>Data Preparation</h2>
                    
                    <h3>Required Data</h3>
                    <ul>
                        <li><strong>Single-cell reference data:</strong> scRNA-seq or snRNA-seq with cell type annotations</li>
                        <li><strong>Spatial transcriptomics data:</strong> ST data from platforms like 10X Visium</li>
                    </ul>

                    <h3>Data Format Requirements</h3>
                    <pre><code class="language-r"># R format - Seurat objects
# Single-cell reference
sc_ref <- readRDS("path/to/sc_data.rds")
# Must contain: sc_ref$clust_vr (cell type annotations)

# Spatial data
st_vis <- readRDS("path/to/st_data.rds")
# Standard Seurat object with spatial assays</code></pre>

                    <pre><code class="language-python"># Python format - AnnData objects
# Single-cell reference
sc_ref = sc.read("path/to/sc.h5ad")
# Must contain: sc_ref.obs['clust_vr'] (cell type annotations)

# Spatial data
st_vis = sc.read("path/to/st.h5ad")</code></pre>
                </section>

                <section id="basic-usage">
                    <h2>Basic Usage</h2>
                    
                    <h3>R Implementation</h3>
                    <pre><code class="language-r"># Load required libraries
library(Seurat)
library(ggplot2)

# Load your data
st_vis <- readRDS('/datapath/ST_data.rds')
sc_ref <- readRDS('/datapath/SC_data.rds')

# Set cluster variable name
clust_vr <- "celltype"  # adjust based on your data

# Run UCASpatial
UCASpatial_result <- UCASpatial_deconv(
    sc_ref = sc_ref,
    st_vis = st_vis,
    clust_vr = clust_vr
)

# Extract results
decon_matr <- as.matrix(UCASpatial_result[[2]])
cell_proportions <- decon_matr[,1:(ncol(decon_matr)-1)]
cell_proportions <- cell_proportions/rowSums(cell_proportions)</code></pre>

                    <h3>Python Implementation</h3>
                    <pre><code class="language-python">import UCASpatial_ds_R1
import scanpy as sc
import pandas as pd

# Load the data
sc_ref = sc.read("path/to/sc.h5ad")
st_vis = sc.read("path/to/st.h5ad")

# Normalize single-cell data
X_norm = sc.pp.normalize_total(sc_ref, target_sum=1, inplace=False)['X']
sc_ref.layers['data'] = X_norm

# Initialize and run UCASpatial
ucas = UCASpatial_ds_R1.UCASpatial(
    sc_ref=sc_ref,
    st_vis=st_vis,
    clust_vr='celltype',  # adjust based on your data
    meta_filter=False,
    random_seed=12345
)

# Get results
result = ucas.run()
nmf_components = result['nmf_components']
cell_proportions = result['proportions']

# Save results
cell_proportions.to_csv('cell_proportions.csv')</code></pre>
                </section>

                <section id="visium-hd">
                    <h2>10X Visium HD Analysis</h2>
                    
                    <h3>R Implementation for Visium HD</h3>
                    <pre><code class="language-r"># For 10X Visium HD data
UCASpatial_result <- UCASpatial_HD_deconv(
    sc_ref = sc_ref,
    st_vis = st_vis,
    spatial.assay = 'Spatial.008um',  # adjust resolution as needed
    clust_vr = clust_vr
)</code></pre>

                    <h3>Tips for HD Data</h3>
                    <ul>
                        <li>Use appropriate spatial resolution (e.g., 'Spatial.008um', 'Spatial.016um')</li>
                        <li>Consider computational resources for high-resolution data</li>
                        <li>Validate results with known tissue markers</li>
                    </ul>
                </section>

                <section id="visualization">
                    <h2>Visualization</h2>
                    
                    <h3>Create Spatial Plots</h3>
                    <pre><code class="language-r"># Prepare data for visualization
decon_df <- cell_proportions %>%
    data.frame() %>%
    tibble::rownames_to_column("barcodes")

# Add to Seurat object
st_vis@meta.data <- st_vis@meta.data %>%
    tibble::rownames_to_column("barcodes") %>%
    dplyr::left_join(decon_df, by = "barcodes") %>%
    tibble::column_to_rownames("barcodes")

# Create assay for cell type proportions
Annotation_assay <- CreateAssayObject(t(cell_proportions))
st_vis@assays$Annotation <- Annotation_assay

# Plot cell type distributions
cell_types_all <- colnames(cell_proportions)
plot_list <- Seurat::SpatialFeaturePlot(
    object = st_vis,
    features = cell_types_all,
    stroke = NA,
    alpha = c(0.3, 1),
    min.cutoff = 0.03
)

# Combine plots
combined_plot <- patchwork::wrap_plots(plot_list, ncol = 3)</code></pre>

                    <h3>Quality Control Plot</h3>
                    <pre><code class="language-r"># Generate evaluation plot
p <- dot_plot_profiles_fun(
    UCASpatial_result[[1]][[1]]@h,
    UCASpatial_result[[1]][[2]]
)[2]
print(p)</code></pre>
                </section>

                <section id="interpretation">
                    <h2>Result Interpretation</h2>
                    
                    <h3>Understanding Outputs</h3>
                    <div class="output-explanation">
                        <h4>Cell Proportion Matrix</h4>
                        <ul>
                            <li>Rows: spatial spots/barcodes</li>
                            <li>Columns: cell types</li>
                            <li>Values: estimated proportion of each cell type (0-1)</li>
                        </ul>

                        <h4>NMF Components</h4>
                        <ul>
                            <li>Represents gene expression programs for each cell type</li>
                            <li>Can be used to identify cell-type specific genes</li>
                        </ul>

                        <h4>Quality Metrics</h4>
                        <ul>
                            <li>Reconstruction error</li>
                            <li>Cell type prediction confidence</li>
                            <li>Spatial coherence of cell type distributions</li>
                        </ul>
                    </div>

                    <h3>Validation Strategies</h3>
                    <ul>
                        <li>Compare with known tissue anatomy</li>
                        <li>Validate with immunohistochemistry markers</li>
                        <li>Cross-validate with other deconvolution methods</li>
                        <li>Check biological coherence of results</li>
                    </ul>
                </section>
            </div>
        </div>
    </section>
</body>
</html>
